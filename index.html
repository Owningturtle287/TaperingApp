<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Personalized Taper Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#60a5fa">

    <link rel="apple-touch-icon" href="icons/icon-180.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Taper">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            900: '#1e3a8a',
                        },
                        dark: {
                            bg: '#020617',     /* Slate 950 */
                            card: '#0f172a',   /* Slate 900 */
                            border: '#1e293b', /* Slate 800 */
                            text: '#f8fafc'    /* Slate 50 */
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 20px -5px rgba(59, 130, 246, 0.35)',
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'slide-in-left': 'slideInLeft 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideInLeft: {
                            '0%': { transform: 'translateX(-20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            font-feature-settings: "cv11", "ss01";
        }
        
        /* Remove Spin Buttons */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Smooth Transitions */
        .transition-theme {
            transition-property: background-color, border-color, color, fill, stroke, box-shadow, opacity, transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }

        /* Progress Ring Animation */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background-color: #334155;
        }

        /* Modal Animation helper */
        .modal-content-enter {
            animation: fadeIn 0.2s ease-out forwards;
        }

        /* Glass effect */
        .glass {
            background: rgba(255, 255, 255, 0.90);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        .dark .glass {
            background: rgba(2, 6, 23, 0.90);
        }
        
        /* Checkbox Animation */
        .checkbox-wrapper input:checked + div {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .checkbox-wrapper input:checked + div svg {
            stroke-dashoffset: 0;
        }
        
        /* Custom Select Wrapper */
        .select-wrapper::after {
            content: "\e9c6"; /* Phosphor caret-down */
            font-family: "Phosphor-Bold";
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-600 dark:bg-dark-bg dark:text-slate-400 transition-theme min-h-screen selection:bg-brand-500 selection:text-white relative pb-32">

    <!-- Sticky Header -->
    <header class="fixed top-0 w-full z-40 glass border-b border-slate-200/50 dark:border-slate-800/50 transition-theme shadow-sm">
        <div class="max-w-md mx-auto px-6 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-display font-bold text-slate-900 dark:text-slate-50 tracking-tight">Taper Tracker</h1>
                <p id="headerSubtitle" class="text-[11px] font-bold text-brand-600 dark:text-brand-400 uppercase tracking-widest">Daily Reminders</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleChangelog()" class="p-2.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all active:scale-95 focus:outline-none">
                    <i class="ph-bold ph-list-dashes text-lg"></i>
                </button>
                <button id="themeToggle" class="group p-2.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-yellow-500 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all active:scale-95 focus:outline-none">
                    <i class="ph-fill ph-moon text-lg group-hover:rotate-12 transition-transform duration-300" id="themeIcon"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Spacer for fixed header -->
    <div class="h-20"></div>

    <main class="max-w-md mx-auto px-6 space-y-6">
        
        <!-- TAB 1: DAILY REMINDERS (DEFAULT) -->
        <div id="tab-reminders" class="animate-slide-up space-y-6">
            
            <!-- Daily Progress Ring & Header -->
            <section class="flex items-end justify-between gap-4 py-2">
                <div>
                     <h2 class="text-3xl font-display font-bold text-slate-900 dark:text-white" id="currentDateDisplay">Today</h2>
                     <p class="text-sm font-medium text-slate-400 dark:text-slate-500" id="currentFullDate">...</p>
                </div>
                <!-- Mini Daily Ring (Lowered and sharper) -->
                <div class="relative w-16 h-16 shrink-0 translate-y-1">
                    <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                        <path class="text-slate-200 dark:text-slate-800" stroke-width="4" stroke="currentColor" fill="none" stroke-linecap="round" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path id="dailyRing" class="text-brand-500 transition-all duration-1000 ease-out" stroke-dasharray="0, 100" stroke-width="4" stroke="currentColor" fill="none" stroke-linecap="round" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span id="dailyPercentText" class="text-[10px] font-bold text-slate-700 dark:text-slate-200">0%</span>
                    </div>
                </div>
            </section>

            <!-- Profiles & Action Buttons -->
            <div class="bg-white dark:bg-dark-card p-4 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-soft space-y-4">
                
                <!-- Custom Profile Dropdown -->
                <div class="relative w-full" id="profileDropdownContainer">
                    <button onclick="toggleProfileDropdown(event)" class="relative w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-white font-semibold py-3 pl-11 pr-10 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500/20 transition-all text-left text-sm flex items-center justify-between">
                        <span id="selectedProfileText" class="truncate">Select Saved Profile...</span>
                        <i class="ph-bold ph-caret-down text-slate-400"></i>
                    </button>
                    
                    <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none text-brand-500">
                        <i class="ph-duotone ph-user-list text-lg"></i>
                    </div>

                    <!-- Dropdown Menu -->
                    <div id="profileMenu" class="hidden absolute top-full left-0 right-0 mt-2 bg-white dark:bg-dark-card border border-slate-100 dark:border-slate-700 rounded-xl shadow-xl z-30 max-h-60 overflow-y-auto overflow-x-hidden transform origin-top transition-all">
                        <!-- Items injected here -->
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="saveProfile()" class="flex-1 bg-slate-900 dark:bg-brand-600 hover:bg-slate-800 dark:hover:bg-brand-500 text-white py-3 rounded-xl font-bold text-xs uppercase tracking-wide shadow-md shadow-slate-200 dark:shadow-none transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                        <i class="ph-bold ph-floppy-disk"></i> Save
                    </button>
                    <button onclick="clearDailyLog()" class="flex-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 py-3 rounded-xl font-bold text-xs uppercase tracking-wide transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                        <i class="ph-bold ph-eraser"></i> Clear
                    </button>
                </div>
            </div>

            <div class="flex justify-between items-center mt-6 px-1">
                <h3 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest flex items-center gap-2">
                    <i class="ph-fill ph-clock-afternoon"></i> Schedule
                </h3>
                <button onclick="openAddMedModal()" class="text-brand-600 dark:text-brand-400 text-xs font-bold hover:text-brand-700 transition-colors flex items-center gap-1.5 bg-brand-50 dark:bg-brand-900/20 px-3 py-1.5 rounded-full">
                    <i class="ph-bold ph-plus"></i> Add New
                </button>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-16 text-center border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-3xl mx-2">
                <div class="w-16 h-16 bg-slate-50 dark:bg-slate-800/50 rounded-full flex items-center justify-center mb-4 text-slate-300 dark:text-slate-600">
                    <i class="ph-duotone ph-pill text-4xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-1">No Reminders Yet</h3>
                <p class="text-sm text-slate-500 max-w-[220px] leading-relaxed">Add your daily medications or load a saved profile to get started.</p>
            </div>

            <!-- Reminders List -->
            <div id="medList" class="space-y-3 pb-8">
                <!-- Med Cards Injected via JS -->
            </div>

        </div>

        <!-- TAB 2: TAPER TRACKER -->
        <div id="tab-taper" class="hidden animate-slide-up space-y-10">
            <!-- Hero: Progress Circle -->
            <section class="flex flex-col items-center justify-center pt-4">
                <div class="relative w-64 h-64">
                    <div class="absolute inset-0 bg-brand-500/10 rounded-full blur-3xl hidden dark:block animate-pulse"></div>
                    <svg class="w-full h-full drop-shadow-xl relative z-10" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="42" fill="none" stroke="currentColor" stroke-width="6" class="text-slate-200 dark:text-slate-800" />
                        <circle id="overallRing" cx="50" cy="50" r="42" fill="none" stroke="currentColor" stroke-width="6" 
                                stroke-linecap="round" stroke-dasharray="264" stroke-dashoffset="264" 
                                class="text-brand-500 progress-ring__circle" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-center z-20">
                        <span id="overallPercent" class="text-5xl font-display font-bold text-slate-900 dark:text-white tracking-tighter">0.0%</span>
                        <span class="text-[10px] text-slate-400 dark:text-slate-500 uppercase tracking-widest font-bold mt-2">Overall<br>Completion</span>
                    </div>
                </div>
                <div class="mt-4 px-6 py-3 bg-white dark:bg-dark-card rounded-2xl border border-slate-100 dark:border-dark-border shadow-soft text-center max-w-[280px]">
                    <p id="motivationalText" class="text-sm font-medium text-slate-600 dark:text-slate-300">
                        Ready to start.
                    </p>
                </div>
            </section>

            <!-- Save Button -->
            <section>
                <button type="button" onclick="manualSave()" class="group w-full flex items-center justify-center gap-2.5 bg-slate-900 dark:bg-brand-600 hover:bg-slate-800 dark:hover:bg-brand-500 text-white py-4 px-6 rounded-2xl font-semibold shadow-lg shadow-slate-900/10 dark:shadow-brand-900/20 transition-all active:scale-[0.98]">
                    <i class="ph-bold ph-floppy-disk text-lg group-hover:animate-bounce"></i> 
                    <span>Save Current Progress</span>
                </button>
            </section>

            <!-- Drug Trackers -->
            <section class="space-y-5">
                <div class="flex items-center gap-2 pb-1 border-b border-slate-200 dark:border-slate-800">
                    <i class="ph-duotone ph-pill text-brand-500"></i>
                    <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">Active Tapers</h2>
                </div>

                <!-- 1. Diazepam -->
                <div class="group bg-white dark:bg-dark-card rounded-3xl p-6 shadow-soft border border-orange-100/50 dark:border-orange-900/20 relative overflow-hidden transition-all hover:shadow-lg dark:hover:border-orange-900/40">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-orange-500/5 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>
                    <div class="flex justify-between items-start mb-6 relative">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-orange-50 dark:bg-orange-500/10 text-orange-500 flex items-center justify-center shadow-inner">
                                <i class="ph-fill ph-pill text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-display font-bold text-lg text-slate-900 dark:text-white">Valium</h3>
                                <div class="flex items-center gap-1.5 mt-0.5">
                                    <span class="w-1.5 h-1.5 rounded-full bg-orange-500 animate-pulse"></span>
                                    <p class="text-xs font-medium text-orange-600 dark:text-orange-400">Active Phase (The Tail)</p>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <span id="diazepamPercent" class="font-display font-bold text-2xl text-slate-900 dark:text-white">0.0%</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-5">
                        <div class="space-y-1.5">
                            <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider pl-1">Start (mg)</label>
                            <input type="number" step="0.01" id="diazepamStart" value="3.75" class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-orange-500/50 focus:border-orange-500 transition-all outline-none text-center" inputmode="decimal">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider pl-1">Current</label>
                            <input type="number" step="0.01" id="diazepamCurrent" value="3.75" class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-orange-500/50 focus:border-orange-500 transition-all outline-none text-center" inputmode="decimal">
                        </div>
                    </div>
                    <div class="relative w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="diazepamBar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-orange-400 to-orange-600 rounded-full transition-all duration-700" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 2. Gabapentin -->
                <div class="group bg-white dark:bg-dark-card rounded-3xl p-6 shadow-soft border border-slate-100 dark:border-slate-800 relative overflow-hidden transition-all hover:shadow-lg">
                    <div class="flex justify-between items-start mb-6 relative">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-blue-50 dark:bg-blue-500/10 text-blue-500 flex items-center justify-center shadow-inner">
                                <i class="ph-fill ph-shield-check text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-display font-bold text-lg text-slate-900 dark:text-white">Gabapentin</h3>
                                <p class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-0.5">Holding Phase (600mg)</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span id="gabaPercent" class="font-display font-bold text-2xl text-slate-900 dark:text-white">0.0%</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-5">
                        <div class="space-y-1.5">
                            <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider pl-1">Start (mg)</label>
                            <input type="number" id="gabaStart" value="600" class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all outline-none text-center" inputmode="decimal">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider pl-1">Current</label>
                            <input type="number" id="gabaCurrent" value="600" class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all outline-none text-center" inputmode="decimal">
                        </div>
                    </div>
                    <div class="relative w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="gabaBar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-blue-400 to-blue-600 rounded-full transition-all duration-700" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 3. Nicotine -->
                <div class="group bg-white dark:bg-dark-card rounded-3xl p-6 shadow-soft border border-slate-100 dark:border-slate-800 relative overflow-hidden transition-all hover:shadow-lg">
                    <div class="flex justify-between items-start mb-6 relative">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 flex items-center justify-center shadow-inner">
                                <i class="ph-fill ph-wind text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-display font-bold text-lg text-slate-900 dark:text-white">Nicotine</h3>
                                <p class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-0.5">Phase IV</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span id="nicotinePercent" class="font-display font-bold text-2xl text-slate-900 dark:text-white">0.0%</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-5">
                        <div class="space-y-1.5">
                            <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider pl-1">Start (mg)</label>
                            <input type="number" id="nicotineStart" value="50" class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-slate-500/50 focus:border-slate-500 transition-all outline-none text-center" inputmode="decimal">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider pl-1">Current</label>
                            <input type="number" id="nicotineCurrent" value="50" class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-slate-500/50 focus:border-slate-500 transition-all outline-none text-center" inputmode="decimal">
                        </div>
                    </div>
                    <div class="relative w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="nicotineBar" class="absolute top-0 left-0 h-full bg-slate-500 rounded-full transition-all duration-700" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- 4. Wellbutrin -->
                <div class="group bg-white dark:bg-dark-card rounded-3xl p-6 shadow-soft border border-slate-100 dark:border-slate-800 relative overflow-hidden transition-all hover:shadow-lg">
                    <div class="flex justify-between items-start mb-6 relative">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-purple-50 dark:bg-purple-500/10 text-purple-500 flex items-center justify-center shadow-inner">
                                <i class="ph-fill ph-brain text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-display font-bold text-lg text-slate-900 dark:text-white">Wellbutrin</h3>
                                <p class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-0.5">Phase IV</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span id="wellPercent" class="font-display font-bold text-2xl text-slate-900 dark:text-white">0.0%</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-5">
                        <div class="space-y-1.5">
                            <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider pl-1">Start (mg)</label>
                            <input type="number" id="wellStart" value="300" class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500 transition-all outline-none text-center" inputmode="decimal">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider pl-1">Current</label>
                            <input type="number" id="wellCurrent" value="300" class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500 transition-all outline-none text-center" inputmode="decimal">
                        </div>
                    </div>
                    <div class="relative w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="wellBar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-purple-400 to-purple-600 rounded-full transition-all duration-700" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 5. Slynd -->
                <div class="group bg-white dark:bg-dark-card rounded-3xl p-6 shadow-soft border border-slate-100 dark:border-slate-800 relative overflow-hidden transition-all hover:shadow-lg">
                    <div class="flex justify-between items-start mb-6 relative">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-rose-50 dark:bg-rose-500/10 text-rose-500 flex items-center justify-center shadow-inner">
                                <i class="ph-fill ph-heart text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-display font-bold text-lg text-slate-900 dark:text-white">Slynd (BC)</h3>
                                <p class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-0.5">Phase V: Prep</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span id="bcPercent" class="font-display font-bold text-2xl text-slate-900 dark:text-white">0.0%</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-5">
                        <div class="space-y-1.5">
                            <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider pl-1">Start (mg)</label>
                            <input type="number" id="bcStart" value="4" class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-rose-500/50 focus:border-rose-500 transition-all outline-none text-center" inputmode="decimal">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider pl-1">Current</label>
                            <input type="number" id="bcCurrent" value="4" class="w-full bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-rose-500/50 focus:border-rose-500 transition-all outline-none text-center" inputmode="decimal">
                        </div>
                    </div>
                    <div class="relative w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="bcBar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-rose-400 to-rose-600 rounded-full transition-all duration-700" style="width: 0%"></div>
                    </div>
                </div>
            </section>

             <!-- Timeline Info -->
             <section class="space-y-6 pt-6">
                 <div class="flex items-center gap-2 pb-1 border-b border-slate-200 dark:border-slate-800">
                    <i class="ph-duotone ph-path text-brand-500"></i>
                    <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">Protocol Timeline</h2>
                 </div>
                 
                 <div class="relative space-y-8 pl-4">
                     <!-- Connector Line -->
                     <div class="absolute left-[27px] top-6 bottom-6 w-0.5 bg-slate-200 dark:bg-slate-800 -z-10"></div>
    
                     <!-- Phase 1 -->
                     <div class="relative pl-8">
                        <div class="absolute left-0 top-1 w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-300 dark:border-slate-600 flex items-center justify-center z-10">
                            <div class="w-2 h-2 rounded-full bg-slate-400"></div>
                        </div>
                        <div class="bg-white dark:bg-dark-card rounded-2xl p-5 border border-slate-100 dark:border-slate-800 shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-display font-bold text-slate-900 dark:text-white">Phase I: Immediate</h4>
                                <span class="text-[10px] font-bold bg-slate-100 dark:bg-slate-800 px-2.5 py-1 rounded-full text-slate-600 dark:text-slate-400 uppercase tracking-wide">Month 1</span>
                            </div>
                            <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
                                Start at <strong>3.75mg Valium</strong>. 
                                <span class="block mt-1 font-medium text-slate-800 dark:text-slate-300">Goal: Stabilization. Maintain others.</span>
                            </p>
                        </div>
                     </div>
    
                     <!-- Phase 2 (Detailed Micro-Taper) -->
                     <div class="relative pl-8">
                        <div class="absolute left-0 top-1 w-6 h-6 rounded-full bg-orange-100 dark:bg-orange-900/30 border-2 border-orange-500 flex items-center justify-center z-10 shadow-[0_0_0_4px_white] dark:shadow-[0_0_0_4px_#020617]">
                            <i class="ph-fill ph-warning text-[10px] text-orange-600 dark:text-orange-400"></i>
                        </div>
                        <div class="bg-white dark:bg-dark-card rounded-2xl p-5 border border-orange-100 dark:border-orange-900/20 shadow-sm">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-display font-bold text-slate-900 dark:text-white">Phase II: The Tail</h4>
                                <span class="text-[10px] font-bold bg-orange-100 dark:bg-orange-900/30 px-2.5 py-1 rounded-full text-orange-700 dark:text-orange-400 uppercase tracking-wide">Mo 1-6</span>
                            </div>
                            <div class="bg-orange-50/50 dark:bg-slate-900/50 rounded-xl p-4 border border-orange-100/50 dark:border-slate-800">
                                <div class="flex items-center gap-2 mb-3 text-orange-700 dark:text-orange-400 font-bold text-xs uppercase tracking-wide">
                                    <i class="ph-bold ph-drop"></i>
                                    <span>Liquid Titration Required</span>
                                </div>
                                <ul class="text-xs text-slate-500 dark:text-slate-400 space-y-2 font-mono leading-relaxed">
                                    <li class="flex items-center gap-2"><span class="w-1 h-1 bg-orange-400 rounded-full"></span> 3.75mg → 3.25mg (Wk 1-3)</li>
                                    <li class="flex items-center gap-2"><span class="w-1 h-1 bg-orange-400 rounded-full"></span> 3.25mg → 2.75mg (Wk 4-6)</li>
                                    <li class="flex items-center gap-2"><span class="w-1 h-1 bg-orange-400 rounded-full"></span> 2.75mg → 2.25mg (Wk 7-9)</li>
                                    <li class="flex items-center gap-2"><span class="w-1 h-1 bg-orange-400 rounded-full"></span> 2.25mg → 1.75mg (Wk 10-12)</li>
                                    <li class="flex items-center gap-2"><span class="w-1 h-1 bg-orange-400 rounded-full"></span> 1.75mg → 1.25mg (Wk 13-15)</li>
                                    <li class="flex items-center gap-2"><span class="w-1 h-1 bg-orange-400 rounded-full"></span> 1.25mg → 0.75mg (Wk 16-18)</li>
                                    <li class="flex items-center gap-2"><span class="w-1 h-1 bg-orange-400 rounded-full"></span> 0.75mg → 0.25mg (Wk 19-21)</li>
                                    <li class="flex items-center gap-2 font-bold text-orange-600 dark:text-orange-400"><i class="ph-fill ph-flag"></i> 0.25mg → 0.00mg (Freedom)</li>
                                </ul>
                            </div>
                        </div>
                     </div>
    
                     <!-- Phase 3 -->
                     <div class="relative pl-8">
                        <div class="absolute left-0 top-1 w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900/30 border-2 border-blue-500 flex items-center justify-center z-10 shadow-[0_0_0_4px_white] dark:shadow-[0_0_0_4px_#020617]">
                            <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                        </div>
                        <div class="bg-white dark:bg-dark-card rounded-2xl p-5 border border-slate-100 dark:border-slate-800 shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-display font-bold text-slate-900 dark:text-white">Phase III: Gabapentin</h4>
                                <span class="text-[10px] font-bold bg-blue-100 dark:bg-blue-900/30 px-2.5 py-1 rounded-full text-blue-600 dark:text-blue-400 uppercase tracking-wide">Mo 7-9</span>
                            </div>
                            <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
                                Wait 4 weeks after Valium zero. Reduce 100mg every 2 weeks.
                            </p>
                            <div class="mt-2 flex flex-wrap gap-1 text-[10px] font-mono text-slate-400">
                                <span>600</span><i class="ph-bold ph-arrow-right text-xs"></i>
                                <span>500</span><i class="ph-bold ph-arrow-right text-xs"></i>
                                <span>400</span><i class="ph-bold ph-arrow-right text-xs"></i>
                                <span>300</span><i class="ph-bold ph-arrow-right text-xs"></i>
                                <span>200</span><i class="ph-bold ph-arrow-right text-xs"></i>
                                <span>100</span><i class="ph-bold ph-arrow-right text-xs"></i>
                                <span class="text-blue-500 font-bold">0</span>
                            </div>
                        </div>
                     </div>
    
                     <!-- Phase 4 -->
                     <div class="relative pl-8">
                        <div class="absolute left-0 top-1 w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-800 border-2 border-slate-400 flex items-center justify-center z-10 shadow-[0_0_0_4px_white] dark:shadow-[0_0_0_4px_#020617]">
                            <div class="w-2 h-2 rounded-full bg-slate-500"></div>
                        </div>
                        <div class="bg-white dark:bg-dark-card rounded-2xl p-5 border border-slate-100 dark:border-slate-800 shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-display font-bold text-slate-900 dark:text-white">Phase IV: Nicotine</h4>
                                <span class="text-[10px] font-bold bg-slate-100 dark:bg-slate-800 px-2.5 py-1 rounded-full text-slate-600 dark:text-slate-400 uppercase tracking-wide">Mo 10-11</span>
                            </div>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mb-3 leading-relaxed">
                                Start <strong>after</strong> Gabapentin. Taper by reducing concentration, not just puffs.
                            </p>
                            <div class="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-3 border border-slate-100 dark:border-slate-800">
                                <ul class="text-xs text-slate-500 dark:text-slate-400 space-y-1.5 font-mono">
                                    <li>• Wk 1-2: 25mg Salts</li>
                                    <li>• Wk 3-4: 12mg Freebase</li>
                                    <li>• Wk 5-6: 6mg Freebase</li>
                                    <li>• Wk 7-8: 3mg Freebase</li>
                                    <li>• Wk 9: 0mg</li>
                                </ul>
                            </div>
                         </div>
                     </div>
    
                     <!-- Phase 5 -->
                     <div class="relative pl-8">
                        <div class="absolute left-0 top-1 w-6 h-6 rounded-full bg-rose-100 dark:bg-rose-900/30 border-2 border-rose-500 flex items-center justify-center z-10 shadow-[0_0_0_4px_white] dark:shadow-[0_0_0_4px_#020617]">
                            <i class="ph-fill ph-heart text-[10px] text-rose-500"></i>
                        </div>
                        <div class="bg-white dark:bg-dark-card rounded-2xl p-5 border border-slate-100 dark:border-slate-800 shadow-sm opacity-75">
                             <div class="flex justify-between items-center mb-1">
                                <h4 class="font-display font-bold text-slate-900 dark:text-white">Phase V: Future</h4>
                                <span class="text-[10px] font-bold bg-rose-100 dark:bg-rose-900/30 px-2.5 py-1 rounded-full text-rose-600 dark:text-rose-400 uppercase tracking-wide">Mo 12+</span>
                            </div>
                            <p class="text-sm text-slate-600 dark:text-slate-400">Washout period complete.</p>
                        </div>
                     </div>
                 </div>
            </section>
        </div>

        <!-- Add/Edit Med Modal -->
        <div id="addMedModal" class="fixed inset-0 z-[50] hidden" role="dialog" aria-modal="true">
            <div class="absolute inset-0 bg-slate-900/40 dark:bg-slate-900/70 backdrop-blur-sm transition-opacity" onclick="closeAddMedModal()"></div>
            <div class="absolute bottom-0 left-0 right-0 p-6 md:top-1/2 md:left-1/2 md:transform md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-sm md:bottom-auto">
                <div class="bg-white dark:bg-dark-card rounded-3xl shadow-2xl border border-slate-200 dark:border-slate-800 p-6 modal-content-enter">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-display font-bold text-slate-900 dark:text-white" id="modalTitle">Add Medication</h3>
                        <button onclick="closeAddMedModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                            <i class="ph-bold ph-x text-lg"></i>
                        </button>
                    </div>

                    <form id="addMedForm" class="space-y-4">
                        <input type="hidden" id="editMedId">
                        
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Name</label>
                            <input type="text" id="newMedName" placeholder="e.g., Valium" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold focus:ring-2 focus:ring-brand-500/50 outline-none dark:text-white transition-all" required>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                             <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Dosage (mg)</label>
                                <input type="text" id="newMedDose" placeholder="e.g., 3.75" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold focus:ring-2 focus:ring-brand-500/50 outline-none dark:text-white transition-all">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Time</label>
                                <!-- Combined Text/Time Input for flexibility -->
                                <div class="relative">
                                    <input type="time" id="newMedTime" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold focus:ring-2 focus:ring-brand-500/50 outline-none dark:text-white transition-all appearance-none" required>
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-4 border border-slate-100 dark:border-slate-800 mt-4">
                            <div class="flex justify-between items-center mb-4">
                                <label class="flex items-center gap-2 text-sm font-semibold text-slate-700 dark:text-slate-300">
                                    <i class="ph-fill ph-bell text-brand-500"></i> Remind Me
                                </label>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="notifyToggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-brand-300 dark:peer-focus:ring-brand-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                                </label>
                            </div>
                            <div id="notifyOptions" class="hidden transition-all">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">Alert Before</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button type="button" onclick="selectOffset(0)" class="offset-btn p-2 rounded-lg border border-slate-200 dark:border-slate-700 text-xs font-medium hover:bg-white dark:hover:bg-slate-800 transition-colors selected-offset" data-val="0">At time</button>
                                    <button type="button" onclick="selectOffset(15)" class="offset-btn p-2 rounded-lg border border-slate-200 dark:border-slate-700 text-xs font-medium hover:bg-white dark:hover:bg-slate-800 transition-colors" data-val="15">15 min</button>
                                    <button type="button" onclick="selectOffset(30)" class="offset-btn p-2 rounded-lg border border-slate-200 dark:border-slate-700 text-xs font-medium hover:bg-white dark:hover:bg-slate-800 transition-colors" data-val="30">30 min</button>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-slate-900 dark:bg-brand-600 hover:bg-slate-800 dark:hover:bg-brand-500 text-white py-3.5 rounded-xl font-bold text-sm shadow-lg shadow-slate-900/10 transition-all active:scale-[0.98] mt-4">
                            Save Medication
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Confirm Modal -->
        <div id="confirmModal" class="fixed inset-0 z-[60] hidden" role="dialog">
            <div class="absolute inset-0 bg-slate-900/40 dark:bg-slate-900/70 backdrop-blur-sm transition-opacity" onclick="closeConfirmModal()"></div>
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-xs p-6">
                <div class="bg-white dark:bg-dark-card rounded-3xl shadow-2xl border border-slate-200 dark:border-slate-800 p-6 text-center modal-content-enter">
                    <div class="w-12 h-12 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center mx-auto mb-4">
                        <i class="ph-bold ph-warning text-2xl text-orange-500"></i>
                    </div>
                    <h3 id="confirmTitle" class="text-lg font-display font-bold text-slate-900 dark:text-white mb-2">Are you sure?</h3>
                    <p id="confirmMessage" class="text-sm text-slate-500 dark:text-slate-400 mb-6 leading-relaxed">This action cannot be undone.</p>
                    <div class="flex gap-3">
                        <button onclick="closeConfirmModal()" class="flex-1 py-3 rounded-xl font-bold text-xs uppercase tracking-wide bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cancel</button>
                        <button id="confirmBtn" class="flex-1 py-3 rounded-xl font-bold text-xs uppercase tracking-wide bg-slate-900 dark:bg-brand-600 hover:bg-slate-800 dark:hover:bg-brand-500 text-white shadow-lg shadow-slate-900/10 dark:shadow-brand-900/20 transition-colors">Confirm</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prompt Modal -->
        <div id="promptModal" class="fixed inset-0 z-[60] hidden" role="dialog">
            <div class="absolute inset-0 bg-slate-900/40 dark:bg-slate-900/70 backdrop-blur-sm transition-opacity" onclick="closePromptModal()"></div>
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-xs p-6">
                <div class="bg-white dark:bg-dark-card rounded-3xl shadow-2xl border border-slate-200 dark:border-slate-800 p-6 modal-content-enter">
                    <div class="w-12 h-12 rounded-full bg-brand-100 dark:bg-brand-900/30 flex items-center justify-center mx-auto mb-4">
                        <i class="ph-bold ph-floppy-disk text-2xl text-brand-600 dark:text-brand-400"></i>
                    </div>
                    <h3 id="promptTitle" class="text-lg font-display font-bold text-slate-900 dark:text-white mb-4 text-center">Save Profile</h3>
                    <input type="text" id="promptInput" placeholder="Enter profile name..." class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-semibold focus:ring-2 focus:ring-brand-500/50 outline-none dark:text-white mb-6 text-center placeholder-slate-400" autocomplete="off">
                    <div class="flex gap-3">
                        <button onclick="closePromptModal()" class="flex-1 py-3 rounded-xl font-bold text-xs uppercase tracking-wide bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">Cancel</button>
                        <button id="promptBtn" class="flex-1 py-3 rounded-xl font-bold text-xs uppercase tracking-wide bg-slate-900 dark:bg-brand-600 hover:bg-slate-800 dark:hover:bg-brand-500 text-white shadow-lg shadow-slate-900/10 dark:shadow-brand-900/20 transition-colors">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Container (Bottom Left Stack) -->
        <div id="toast-container" class="fixed bottom-24 left-6 z-50 flex flex-col gap-2 pointer-events-none">
            <!-- Toasts will be injected here -->
        </div>

        <!-- Changelog Modal -->
        <div id="changelogModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
            <div class="absolute inset-0 bg-slate-900/40 dark:bg-slate-900/70 backdrop-blur-sm transition-opacity" onclick="toggleChangelog()"></div>
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-6">
                <div class="bg-white dark:bg-dark-card rounded-3xl shadow-2xl border border-slate-200 dark:border-slate-800 p-6 modal-content-enter">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-2">
                            <i class="ph-duotone ph-list-dashes text-brand-500 text-xl"></i>
                            <h3 class="text-lg font-display font-bold text-slate-900 dark:text-white">Changelog</h3>
                        </div>
                        <button onclick="toggleChangelog()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                            <i class="ph-bold ph-x text-lg"></i>
                        </button>
                    </div>
                    <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        <div class="relative pl-4 border-l-2 border-brand-500">
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="text-sm font-bold text-slate-900 dark:text-white">v1.9.0</span>
                                <span class="text-[10px] font-medium text-slate-500 uppercase tracking-wide">Latest</span>
                            </div>
                            <ul class="text-xs text-slate-500 dark:text-slate-400 space-y-1 list-disc pl-3">
                                <li><strong>Fix:</strong> Notifications recur daily automatically (persisted tracking).</li>
                                <li><strong>Fix:</strong> Alerts fire even if medication is checked off (optional safeguard).</li>
                                <li><strong>Logic:</strong> Midnight cycle reset improvements.</li>
                            </ul>
                        </div>
                        <div class="relative pl-4 border-l-2 border-slate-200 dark:border-slate-700">
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="text-sm font-bold text-slate-500 dark:text-slate-400">v1.8.0</span>
                            </div>
                            <ul class="text-xs text-slate-400 dark:text-slate-500 space-y-1 list-disc pl-3">
                                <li>Daily recurring notification fix.</li>
                                <li>Service Worker updates.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 w-full z-50 glass border-t border-slate-200/50 dark:border-slate-800/50 pb-safe">
        <div class="max-w-md mx-auto flex justify-around items-center h-16 px-2">
            <button onclick="switchTab('reminders')" id="nav-reminders" class="flex flex-col items-center justify-center w-full h-full text-brand-500 dark:text-brand-400 transition-colors">
                <i class="ph-fill ph-calendar-check text-2xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase tracking-wide">Daily</span>
            </button>
            <button onclick="switchTab('taper')" id="nav-taper" class="flex flex-col items-center justify-center w-full h-full text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                <i class="ph-duotone ph-chart-donut text-2xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase tracking-wide">Plan</span>
            </button>
        </div>
    </nav>

    <!-- Logic -->
    <script>
        // --- GLOBAL STATE ---
        let currentTab = 'reminders';
        let medications = JSON.parse(localStorage.getItem('medications')) || [];
        let dailyLogs = JSON.parse(localStorage.getItem('dailyLogs')) || {}; 
        let savedProfiles = JSON.parse(localStorage.getItem('profiles')) || {}; 
        let lastNotificationDate = JSON.parse(localStorage.getItem('lastNotificationDate')) || {}; // Map: "medId" -> "dateString"
        let selectedNotifyOffset = 0;
        let lastDateKey = '';
        
        // Modal Callbacks
        let confirmCallback = null;
        let cancelConfirmCallback = null;
        let promptCallback = null;

        // --- 1. MODAL HELPERS ---
        function openConfirmModal(title, message, onConfirm, onCancel = null) {
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = message;
            confirmCallback = onConfirm;
            cancelConfirmCallback = onCancel;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            if (cancelConfirmCallback) cancelConfirmCallback();
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
            cancelConfirmCallback = null;
        }

        document.getElementById('confirmBtn').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            cancelConfirmCallback = null;
            closeConfirmModal();
        });

        function openPromptModal(title, placeholder, onSave) {
            document.getElementById('promptTitle').innerText = title;
            const input = document.getElementById('promptInput');
            input.placeholder = placeholder;
            input.value = '';
            promptCallback = onSave;
            document.getElementById('promptModal').classList.remove('hidden');
            setTimeout(() => input.focus(), 100);
        }

        function closePromptModal() {
            document.getElementById('promptModal').classList.add('hidden');
            promptCallback = null;
        }

        document.getElementById('promptBtn').addEventListener('click', () => {
            const val = document.getElementById('promptInput').value;
            if (promptCallback) promptCallback(val);
            closePromptModal();
        });
        
        document.getElementById('promptInput').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                const val = document.getElementById('promptInput').value;
                if (promptCallback) promptCallback(val);
                closePromptModal();
            }
        });

        // --- 2. TAB HANDLING ---
        function switchTab(tab) {
            currentTab = tab;
            const tabReminders = document.getElementById('tab-reminders');
            const tabTaper = document.getElementById('tab-taper');
            const navReminders = document.getElementById('nav-reminders');
            const navTaper = document.getElementById('nav-taper');
            const subtitle = document.getElementById('headerSubtitle');

            if (tab === 'reminders') {
                tabReminders.classList.remove('hidden');
                tabTaper.classList.add('hidden');
                
                navReminders.classList.remove('text-slate-400', 'dark:text-slate-500');
                navReminders.classList.add('text-brand-500', 'dark:text-brand-400');
                navReminders.querySelector('i').classList.replace('ph-duotone', 'ph-fill');

                navTaper.classList.add('text-slate-400', 'dark:text-slate-500');
                navTaper.classList.remove('text-brand-500', 'dark:text-brand-400');
                navTaper.querySelector('i').classList.replace('ph-fill', 'ph-duotone');
                
                subtitle.innerText = "Daily Reminders";
                renderMedList();
                renderProfileOptions();
            } else {
                tabReminders.classList.add('hidden');
                tabTaper.classList.remove('hidden');

                navTaper.classList.remove('text-slate-400', 'dark:text-slate-500');
                navTaper.classList.add('text-brand-500', 'dark:text-brand-400');
                navTaper.querySelector('i').classList.replace('ph-duotone', 'ph-fill');

                navReminders.classList.add('text-slate-400', 'dark:text-slate-500');
                navReminders.classList.remove('text-brand-500', 'dark:text-brand-400');
                navReminders.querySelector('i').classList.replace('ph-fill', 'ph-duotone');

                subtitle.innerText = "Taper Plan";
            }
        }

        // --- 3. CUSTOM PROFILE DROPDOWN LOGIC ---
        
        function toggleProfileDropdown(e) {
            if(e) e.stopPropagation();
            const menu = document.getElementById('profileMenu');
            menu.classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        window.addEventListener('click', (e) => {
            const container = document.getElementById('profileDropdownContainer');
            const menu = document.getElementById('profileMenu');
            if (container && menu && !container.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        function renderProfileOptions() {
            const menu = document.getElementById('profileMenu');
            menu.innerHTML = '';
            
            const keys = Object.keys(savedProfiles);
            
            if (keys.length === 0) {
                menu.innerHTML = '<div class="p-4 text-xs text-slate-400 text-center font-medium italic">No saved profiles yet</div>';
                return;
            }

            keys.forEach(name => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-2 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors border-b border-slate-50 dark:border-slate-700/50 last:border-0 group';
                item.innerHTML = `
                    <button onclick="loadProfile('${name}')" class="flex-1 text-left text-sm font-semibold text-slate-700 dark:text-slate-200 px-2 py-1.5 truncate">
                        ${name}
                    </button>
                    <button onclick="deleteProfile(event, '${name}')" class="p-2 text-slate-300 hover:text-red-500 transition-colors rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">
                        <i class="ph-bold ph-trash"></i>
                    </button>
                `;
                menu.appendChild(item);
            });
        }

        function saveProfile() {
            if (medications.length === 0) {
                showToast("Add medications before saving!");
                return;
            }
            
            openPromptModal("Save Profile", "Enter profile name...", (name) => {
                if(name && name.trim() !== "") {
                    const cleanName = name.trim();
                    savedProfiles[cleanName] = JSON.parse(JSON.stringify(medications));
                    localStorage.setItem('profiles', JSON.stringify(savedProfiles));
                    
                    renderProfileOptions();
                    
                    // Update header text to show current profile
                    document.getElementById('selectedProfileText').innerText = cleanName;
                    
                    showToast(`Profile "${cleanName}" saved`);
                }
            });
        }

        function loadProfile(name) {
            if(savedProfiles[name]) {
                openConfirmModal(
                    "Load Profile?", 
                    `Load "${name}"? This will replace your current schedule.`, 
                    () => {
                        medications = JSON.parse(JSON.stringify(savedProfiles[name]));
                        localStorage.setItem('medications', JSON.stringify(medications));
                        renderMedList();
                        
                        document.getElementById('selectedProfileText').innerText = name;
                        document.getElementById('profileMenu').classList.add('hidden');
                        
                        showToast(`Loaded "${name}"`);
                    },
                    () => {
                        // Cancel action
                        document.getElementById('profileMenu').classList.add('hidden');
                    }
                );
            }
        }

        function deleteProfile(e, name) {
            if(e) e.stopPropagation(); // Prevent loading the profile when clicking delete
            
            openConfirmModal(
                "Delete Profile?", 
                `Permanently delete "${name}"?`,
                () => {
                    delete savedProfiles[name];
                    localStorage.setItem('profiles', JSON.stringify(savedProfiles));
                    renderProfileOptions();
                    
                    // Reset text if we deleted the currently selected one
                    const currentText = document.getElementById('selectedProfileText').innerText;
                    if(currentText === name) {
                        document.getElementById('selectedProfileText').innerText = "Select Saved Profile...";
                    }
                    
                    showToast(`Profile deleted`);
                }
            );
        }

        // --- 4. MEDICATION LOGIC ---
        
        function getTodayKey() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function checkMidnightReset() {
            const today = getTodayKey();
            if (lastDateKey && lastDateKey !== today) {
                renderMedList(); 
            }
            lastDateKey = today;
        }

        function renderMedList() {
            const list = document.getElementById('medList');
            const emptyState = document.getElementById('emptyState');
            const fullDateDisplay = document.getElementById('currentFullDate');
            
            const now = new Date();
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            fullDateDisplay.innerText = now.toLocaleDateString('en-US', options);
            
            list.innerHTML = '';

            if (medications.length === 0) {
                emptyState.classList.remove('hidden');
                updateDailyRing(0, 0);
            } else {
                emptyState.classList.add('hidden');
                
                medications.sort((a, b) => a.time.localeCompare(b.time));

                const todayKey = getTodayKey();
                const todayLog = dailyLogs[todayKey] || {};
                
                let takenCount = 0;

                medications.forEach(med => {
                    const isTaken = !!todayLog[med.id];
                    if (isTaken) takenCount++;
                    const takenTime = isTaken ? todayLog[med.id] : null;

                    const div = document.createElement('div');
                    div.className = `relative bg-white dark:bg-dark-card rounded-2xl p-4 border transition-all group ${
                        isTaken 
                        ? 'border-slate-100 dark:border-slate-800' 
                        : 'border-slate-100 dark:border-slate-800 shadow-sm'
                    }`;

                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <label class="checkbox-wrapper relative cursor-pointer z-10">
                                    <input type="checkbox" class="sr-only peer" 
                                        onchange="toggleMed('${med.id}')" ${isTaken ? 'checked' : ''}>
                                    <div class="w-12 h-12 rounded-xl border-2 border-slate-200 dark:border-slate-700 flex items-center justify-center transition-colors peer-focus:ring-2 peer-focus:ring-brand-500/30">
                                        <svg class="w-6 h-6 text-white stroke-current stroke-2 fill-none stroke-dasharray-[24] stroke-dashoffset-[24] transition-all duration-300" viewBox="0 0 24 24">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                </label>
                                <div class="${isTaken ? 'opacity-50' : ''} transition-opacity">
                                    <h4 class="font-display font-bold text-lg text-slate-900 dark:text-white ${isTaken ? 'line-through decoration-slate-400' : ''}">${med.name}</h4>
                                    <div class="flex items-center gap-2 text-xs font-medium text-slate-500">
                                        <span class="bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-slate-600 dark:text-slate-400">${med.dose}mg</span>
                                        <span class="flex items-center gap-1">
                                            <i class="ph-bold ph-clock"></i> ${formatTime(med.time)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-2 relative z-10">
                                ${isTaken 
                                    ? `<span class="text-[10px] font-bold uppercase tracking-wide text-brand-600 dark:text-brand-400 bg-brand-50 dark:bg-brand-900/20 px-2 py-1 rounded-full">Taken ${takenTime}</span>`
                                    : ''
                                }
                                <div class="flex gap-1">
                                    <button onclick="editMed('${med.id}')" class="text-slate-300 hover:text-brand-500 transition-colors p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 touch-manipulation"><i class="ph-bold ph-pencil-simple text-lg"></i></button>
                                    <button onclick="deleteMed('${med.id}')" class="text-slate-300 hover:text-red-500 transition-colors p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 touch-manipulation"><i class="ph-bold ph-trash text-lg"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
                
                updateDailyRing(takenCount, medications.length);
            }
        }
        
        function updateDailyRing(taken, total) {
            const percent = total === 0 ? 0 : Math.round((taken / total) * 100);
            const ring = document.getElementById('dailyRing');
            const text = document.getElementById('dailyPercentText');
            ring.style.strokeDasharray = `${percent}, 100`;
            text.innerText = `${percent}%`;
        }

        function formatTime(timeStr) {
            const [h, m] = timeStr.split(':');
            const date = new Date();
            date.setHours(h, m);
            return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        }

        function toggleMed(id) {
            const todayKey = getTodayKey();
            if (!dailyLogs[todayKey]) dailyLogs[todayKey] = {};

            if (dailyLogs[todayKey][id]) {
                delete dailyLogs[todayKey][id];
            } else {
                const now = new Date();
                const timeStr = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                dailyLogs[todayKey][id] = timeStr;
                try { if (navigator.vibrate) navigator.vibrate(50); } catch(e){}
            }
            
            localStorage.setItem('dailyLogs', JSON.stringify(dailyLogs));
            renderMedList();
        }

        function deleteMed(id) {
            openConfirmModal("Delete Medication?", "This action cannot be undone.", () => {
                medications = medications.filter(m => m.id !== id);
                localStorage.setItem('medications', JSON.stringify(medications));
                renderMedList();
                showToast("Medication deleted");
            });
        }
        
        function clearDailyLog() {
            if(Object.keys(dailyLogs[getTodayKey()] || {}).length === 0) {
                showToast("Nothing to clear");
                return;
            }
            
            openConfirmModal("Clear Today?", "Reset all 'Taken' statuses for today.", () => {
                const todayKey = getTodayKey();
                dailyLogs[todayKey] = {}; 
                localStorage.setItem('dailyLogs', JSON.stringify(dailyLogs));
                renderMedList();
                showToast('Daily log cleared');
            });
        }

        // --- 5. ADD/EDIT MODAL LOGIC ---

        function openAddMedModal(editId = null) {
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('addMedForm');
            
            if (editId) {
                const med = medications.find(m => m.id === editId);
                if (!med) return;
                
                modalTitle.innerText = "Edit Medication";
                document.getElementById('editMedId').value = med.id;
                document.getElementById('newMedName').value = med.name;
                document.getElementById('newMedDose').value = med.dose;
                document.getElementById('newMedTime').value = med.time;
                document.getElementById('notifyToggle').checked = med.notify;
                
                selectOffset(med.notifyOffset || 0);
                applyNotificationToggleState(med.notify);
                
            } else {
                modalTitle.innerText = "Add Medication";
                document.getElementById('editMedId').value = "";
                form.reset();
                applyNotificationToggleState(false);
                selectOffset(0);
            }
            
            document.getElementById('addMedModal').classList.remove('hidden');
        }
        
        function editMed(id) {
            openAddMedModal(id);
        }

        function closeAddMedModal() {
            document.getElementById('addMedModal').classList.add('hidden');
        }

        function applyNotificationToggleState(enabled) {
            const opts = document.getElementById('notifyOptions');
            opts.classList.toggle('hidden', !enabled);
        }

        document.getElementById('notifyToggle').addEventListener('change', async (e) => {
            const toggle = e.target;
            if (!toggle.checked) {
                applyNotificationToggleState(false);
                return;
            }

            if (!("Notification" in window)) {
                toggle.checked = false;
                applyNotificationToggleState(false);
                showToast('Notifications are not supported in this browser.');
                return;
            }

            if (Notification.permission === "granted") {
                applyNotificationToggleState(true);
                return;
            }

            const permission = await Notification.requestPermission();
            const allowed = permission === "granted";
            toggle.checked = allowed;
            applyNotificationToggleState(allowed);

            if (!allowed) {
                showToast('Enable notification permission in browser settings to use reminders.');
            }
        });

        function selectOffset(val) {
            selectedNotifyOffset = val;
            document.querySelectorAll('.offset-btn').forEach(btn => {
                btn.classList.remove('bg-brand-50', 'dark:bg-brand-900/20', 'text-brand-600', 'dark:text-brand-400', 'border-brand-200', 'dark:border-brand-800');
                if(parseInt(btn.dataset.val) === val) {
                    btn.classList.add('bg-brand-50', 'dark:bg-brand-900/20', 'text-brand-600', 'dark:text-brand-400', 'border-brand-200', 'dark:border-brand-800');
                }
            });
        }

        document.getElementById('addMedForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const editId = document.getElementById('editMedId').value;
            const name = document.getElementById('newMedName').value;
            const dose = document.getElementById('newMedDose').value;
            const time = document.getElementById('newMedTime').value;
            const notify = document.getElementById('notifyToggle').checked;

            if (editId) {
                const index = medications.findIndex(m => m.id === editId);
                if (index !== -1) {
                    medications[index] = {
                        ...medications[index],
                        name, dose, time, notify, notifyOffset: selectedNotifyOffset
                    };
                }
                showToast('Medication Updated');
            } else {
                const newMed = {
                    id: Date.now().toString(),
                    name,
                    dose,
                    time,
                    notify,
                    notifyOffset: selectedNotifyOffset
                };
                medications.push(newMed);
                showToast('Medication Added');
            }

            localStorage.setItem('medications', JSON.stringify(medications));
            closeAddMedModal();
            renderMedList();
        });

        // --- 6. NOTIFICATION & TIME CHECKER ---
        
        setInterval(() => {
            const now = new Date();
            checkMidnightReset();

            const currentH = now.getHours();
            const currentM = now.getMinutes();
            if (now.getSeconds() > 5) return; 

            medications.forEach(med => {
                if (!med.notify) return;
                const [medH, medM] = med.time.split(':').map(Number);
                let targetTotalMins = (medH * 60) + medM - med.notifyOffset;
                if (targetTotalMins < 0) targetTotalMins += 1440;
                const currentTotalMins = (currentH * 60) + currentM;

                if (currentTotalMins === targetTotalMins) {
                    sendNotification(med);
                }
            });
        }, 5000); 

        function sendNotification(med) {
            // FIX: Use localStorage to track last notification date per med
            const todayStr = new Date().toDateString(); // e.g. "Tue Dec 09 2025"
            const lastSent = lastNotificationDate[med.id];

            // If already sent today, skip
            if (lastSent === todayStr) return;

            if ("Notification" in window && Notification.permission === "granted") {
                const title = `Time for ${med.name}`;
                const body = med.notifyOffset > 0 
                    ? `Upcoming dose (${med.dose}mg) in ${med.notifyOffset} mins.` 
                    : `Take your ${med.dose}mg dose now.`;
                
                // Use Service Worker for Android if available
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.ready.then(function(registration) {
                        registration.showNotification(title, {
                            body: body,
                            icon: 'icons/icon-192.png',
                            badge: 'icons/icon-192.png',
                            vibrate: [200, 100, 200],
                            tag: `${med.id}-${todayStr}`, // Unique tag per day ensures it shows up again tomorrow
                            renotify: true
                        });
                    });
                } else {
                    // Fallback
                    new Notification(title, { body, icon: 'icons/icon-192.png' });
                }
            } 
            
            showToast(`Reminder: ${med.name} (${med.dose}mg)`);
            
            // Mark as sent for today
            lastNotificationDate[med.id] = todayStr;
            localStorage.setItem('lastNotificationDate', JSON.stringify(lastNotificationDate));
        }
        
        // --- TOAST STACK LOGIC ---
        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'bg-slate-900/90 dark:bg-white/90 backdrop-blur-md text-white dark:text-slate-900 px-5 py-3 rounded-2xl shadow-2xl text-sm font-semibold flex items-center gap-3 toast-show pointer-events-auto transform transition-all duration-500';
            toast.innerHTML = `<i class="ph-fill ph-check-circle text-brand-400 dark:text-green-600 text-lg"></i><span>${msg}</span>`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-20px)';
                setTimeout(() => {
                    if (toast.parentNode) toast.parentNode.removeChild(toast);
                }, 300);
            }, 5000);
        }

        // --- OLD TAPER LOGIC (UNCHANGED) ---
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const html = document.documentElement;

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
            html.classList.remove('light');
            themeIcon.classList.replace('ph-moon', 'ph-sun');
        } else {
            html.classList.remove('dark');
            html.classList.add('light');
            themeIcon.classList.replace('ph-sun', 'ph-moon');
        }

        themeToggle.addEventListener('click', () => {
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                html.classList.add('light');
                localStorage.theme = 'light';
                themeIcon.classList.replace('ph-sun', 'ph-moon');
            } else {
                html.classList.add('dark');
                html.classList.remove('light');
                localStorage.theme = 'dark';
                themeIcon.classList.replace('ph-moon', 'ph-sun');
            }
        });

        const drugsList = ['nicotine', 'diazepam', 'gaba', 'well', 'bc'];
        const defaults = { nicotine: 50, diazepam: 3.75, gaba: 600, well: 300, bc: 4 };
        const getInputs = (name) => ({
            start: document.getElementById(`${name}Start`),
            current: document.getElementById(`${name}Current`),
            bar: document.getElementById(`${name}Bar`),
            text: document.getElementById(`${name}Percent`)
        });
        const inputs = {};
        drugsList.forEach(drug => { inputs[drug] = getInputs(drug); });
        const overallRing = document.getElementById('overallRing');
        const overallPercentText = document.getElementById('overallPercent');
        const motivationalText = document.getElementById('motivationalText');

        function loadTaperData() {
            drugsList.forEach(drug => {
                const savedStart = localStorage.getItem(`${drug}Start`);
                const savedCurrent = localStorage.getItem(`${drug}Current`);
                if(savedStart !== null) inputs[drug].start.value = savedStart;
                else inputs[drug].start.value = defaults[drug];
                if(savedCurrent !== null) inputs[drug].current.value = savedCurrent;
                else inputs[drug].current.value = defaults[drug];
            });
            calculateAll();
        }

        function calculatePercentage(start, current) {
            if (!start || start <= 0) return 0;
            if (!current && current !== 0) return 0;
            if (current < 0) current = 0;
            let percent = ((start - current) / start) * 100;
            if (percent > 100) percent = 100;
            if (percent < 0) percent = 0;
            return percent;
        }

        function updateUI(drug, percent) {
            inputs[drug].text.innerText = `${percent.toFixed(1)}%`;
            inputs[drug].bar.style.width = `${percent}%`;
        }

        function calculateAll() {
            let totalPercent = 0;
            let activeDrugs = 0;
            drugsList.forEach(drug => {
                const start = parseFloat(inputs[drug].start.value);
                const current = parseFloat(inputs[drug].current.value);
                if (start > 0) {
                    const percent = calculatePercentage(start, current);
                    updateUI(drug, percent);
                    totalPercent += percent;
                    activeDrugs++;
                } else {
                    updateUI(drug, 0);
                }
            });
            let finalOverall = 0;
            if (activeDrugs > 0) finalOverall = totalPercent / activeDrugs;
            const radius = 42; 
            const circumference = 2 * Math.PI * radius; 
            const offset = circumference - (finalOverall / 100) * circumference;
            overallRing.style.strokeDasharray = `${circumference} ${circumference}`;
            overallRing.style.strokeDashoffset = offset;
            overallPercentText.innerText = `${finalOverall.toFixed(1)}%`;
            if (finalOverall === 0) motivationalText.innerText = "Ready to start the micro-taper.";
            else if (finalOverall < 25) motivationalText.innerText = "Slow and steady. Respect the tail.";
            else if (finalOverall < 50) motivationalText.innerText = "Halfway. Keep the gabapentin stable.";
            else if (finalOverall < 75) motivationalText.innerText = "Excellent. Prepare for Phase 3.";
            else if (finalOverall < 99.9) motivationalText.innerText = "Almost home. Finish strong."; 
            else motivationalText.innerText = "You are drug free. Congratulations.";
        }

        function manualSave() {
            drugsList.forEach(drug => {
                localStorage.setItem(`${drug}Start`, inputs[drug].start.value);
                localStorage.setItem(`${drug}Current`, inputs[drug].current.value);
            });
            showToast("Progress Saved");
        }

        function toggleChangelog() {
            const modal = document.getElementById('changelogModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; 
            } else {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        Object.values(inputs).forEach(drug => {
            drug.start.addEventListener('input', calculateAll);
            drug.current.addEventListener('input', calculateAll);
        });

        // Initialize Everything
        loadTaperData();
        switchTab('reminders'); 
        renderMedList();
        renderProfileOptions();

    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
              if (window.location.protocol.startsWith('http')) {
                  navigator.serviceWorker
                    .register('sw.js')
                    .catch(err => console.error('SW registration failed', err));
              }
            });
        }
    </script>
</body>
</html>
